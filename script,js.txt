
const API_KEY = "d6bdh5pr01qnr27kip70d6bdh5pr01qnr27kip7g";

const stockList = document.getElementById("stockList");
const searchInput = document.getElementById("search");
const searchBtn = document.getElementById("searchBtn");

let chart;
let interval;

async function fetchQuote(symbol) {
  const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`);
  return await res.json();
}

async function fetchCandle(symbol) {
  const now = Math.floor(Date.now() / 1000);
  const dayAgo = now - 60 * 60 * 24;

  const res = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=30&from=${dayAgo}&to=${now}&token=${API_KEY}`);
  return await res.json();
}

async function loadStock(symbol) {
  clearInterval(interval);

  document.getElementById("stockName").textContent = symbol.toUpperCase();

  async function update() {
    try {
      const quote = await fetchQuote(symbol);

      if (!quote.c) {
        document.getElementById("stockPrice").textContent = "Invalid Symbol";
        return;
      }

      const price = quote.c;
      const change = quote.d;

      document.getElementById("stockPrice").textContent = `$${price}`;

      const changeEl = document.getElementById("stockChange");
      changeEl.textContent = `${change > 0 ? "+" : ""}${change.toFixed(2)}`;
      changeEl.className = change >= 0 ? "green" : "red";

      const candle = await fetchCandle(symbol);

      if (chart) chart.destroy();

      chart = new Chart(document.getElementById("chart"), {
        type: "line",
        data: {
          labels: candle.t.map(t => new Date(t * 1000).toLocaleTimeString()),
          datasets: [{ data: candle.c, tension: 0.4, borderWidth: 2 }]
        },
        options: { plugins: { legend: { display: false } }, scales: { x: { display: false } } }
      });
    } catch (err) {
      console.error("API error:", err);
    }
  }

  await update();
  interval = setInterval(update, 15000);
}

searchBtn.addEventListener("click", () => {
  const symbol = searchInput.value.trim();
  if (symbol) loadStock(symbol);
});

searchInput.addEventListener("keypress", e => {
  if (e.key === "Enter") searchBtn.click();
});

// default
loadStock("AAPL");
